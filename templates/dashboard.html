{% extends "base.html" %}

{% block content %}
<style>
    .chart-container canvas {
        pointer-events: none !important;
    }
    .chart-container {
        pointer-events: none !important;
    }
    /* Disable card hover effects for chart containers */
    .chart-container .card.border-0:hover,
    .chart-container .card.shadow-sm:hover {
        transform: none !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
        z-index: auto !important;
    }
    .chart-container .card:hover .card-body {
        background: transparent !important;
    }

    /* Remove hover effect from bar chart card and container */
    #vulnTypeChart, #vulnTypeChart:focus {
        pointer-events: auto !important;
    }
    .card.border-0.shadow-sm:not(.no-hover-effect):hover,
    .card.border-0.shadow-sm:not(.no-hover-effect):focus {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
        transform: none !important;
        background: #fff !important;
        z-index: auto !important;
        transition: none !important;
        cursor: default !important;
    }
    .card.border-0.shadow-sm:not(.no-hover-effect):hover .card-body,
    .card.border-0.shadow-sm:not(.no-hover-effect):focus .card-body {
        background: #fff !important;
        transition: none !important;
    }

    /* Only disable pointer events and hover for vulnSeverityChart and its card */
    #vulnSeverityChart, #vulnSeverityChart:focus {
        pointer-events: auto !important;
    }
    .no-hover-effect,
    .no-hover-effect:hover,
    .no-hover-effect:focus,
    .no-hover-effect:active,
    .no-hover-effect:visited {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
        transform: none !important;
        background: #fff !important;
        z-index: auto !important;
        transition: none !important;
        cursor: default !important;
    }
    .no-hover-effect .card-body,
    .no-hover-effect:hover .card-body {
        background: #fff !important;
        transition: none !important;
    }
</style>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Dashboard Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-1">Security Dashboard</h2>
                    <p class="text-muted mb-0">Welcome back, {{ current_user.firstname }} {{ current_user.lastname }}!</p>
                </div>
                <a href="{{ url_for('scans_page') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus-circle me-2"></i>New Scan
                </a>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="text-muted mb-1 small">Total Scans</p>
                                    <h3 id="totalScansCount" class="fw-bold mb-0">{{ stats.total_scans }}</h3>
                                    <small class="text-muted">All time</small>
                                </div>
                                <div class="bg-primary bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-search text-primary fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="text-muted mb-1 small">Completed</p>
                                    <h3 id="completedScansCount" class="fw-bold mb-0">{{ stats.completed_scans }}</h3>
                                    {% if stats.total_scans > 0 %}
                                    <small id="successRate" class="text-success">{{ stats.success_rate }}% success rate</small>
                                    {% else %}
                                    <small id="successRate" class="text-muted">No scans yet</small>
                                    {% endif %}
                                </div>
                                <div class="bg-success bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-check-circle text-success fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <p class="text-muted mb-1 small">Vulnerabilities by Severity</p>
                                    <h3 id="severityCount" class="fw-bold mb-0">{{ stats.total_vulnerabilities }}</h3>
                                    <small id="severityLabel" class="text-muted">Total vulnerabilities</small>
                                </div>
                                <div class="bg-danger bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-shield-alt text-danger fa-lg"></i>
                                </div>
                            </div>
                            <!-- Filter Buttons -->
                            <div class="btn-group btn-group-sm w-100 mt-2" role="group">
                                <button type="button" class="btn btn-outline-secondary active" id="filterAll" onclick="filterSeverity('all')">
                                    All
                                </button>
                                <button type="button" class="btn btn-outline-dark" id="filterCritical" onclick="filterSeverity('critical')">
                                    Critical
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="filterHigh" onclick="filterSeverity('high')">
                                    High
                                </button>
                                <button type="button" class="btn btn-outline-warning" id="filterMedium" onclick="filterSeverity('medium')">
                                    Medium
                                </button>
                                <button type="button" class="btn btn-outline-info" id="filterLow" onclick="filterSeverity('low')">
                                    Low
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="filterInfo" onclick="filterSeverity('info')">
                                    Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="text-muted mb-1 small">Vulnerabilities</p>
                                    <h3 id="totalVulnsCount" class="fw-bold mb-0 text-danger">{{ stats.total_vulnerabilities }}</h3>
                                    {% if stats.completed_scans > 0 %}
                                    <small id="avgVulns" class="text-muted">Avg: {{ stats.avg_vulnerabilities }} per scan</small>
                                    {% else %}
                                    <small id="avgVulns" class="text-muted">No data yet</small>
                                    {% endif %}
                                </div>
                                <div class="bg-danger bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-exclamation-triangle text-danger fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Charts Row -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body chart-container">
                            <h6 class="card-title mb-3" style="pointer-events: auto;"><i class="fas fa-chart-pie me-2 text-primary"></i>Vulnerabilities by Type</h6>
                            <canvas id="vulnTypeChart" height="146"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm no-hover-effect">
                        <div class="card-body chart-container">
                            <h6 class="card-title mb-3" style="pointer-events: auto;"><i class="fas fa-chart-bar me-2 text-danger"></i>Vulnerabilities by Severity</h6>
                            <canvas id="vulnSeverityChart" width="300" height="250" style="display:block;margin:0 auto;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Scans Table -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0"><i class="fas fa-history me-2 text-primary"></i>Recent Scans</h5>
                </div>
                <div class="card-body p-0">
                    {% if scans %}
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                        <table class="table table-hover mb-0" id="scansTable">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th>Target URL</th>
                                    <th>Scan Type</th>
                                    <th>Status</th>
                                    <th>Vulnerabilities</th>
                                    <th>Score</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for scan in scans %}
                                <tr>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;">
                                            <i class="fas fa-globe text-muted me-2"></i>
                                            <span title="{{ scan.target_url }}">{{ scan.target_url }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ scan.scan_type.replace('_', ' ').title() }}</span>
                                    </td>
                                    <td>
                                        {% if scan.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif scan.status == 'running' %}
                                            <span class="badge bg-warning">Running</span>
                                        {% elif scan.status == 'stopped' %}
                                            <span class="badge bg-secondary">Stopped</span>
                                        {% else %}
                                            <span class="badge bg-danger">Error</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if scan.status == 'completed' %}
                                            {% if scan.vulnerabilities_count > 0 %}
                                                <span class="badge bg-danger">{{ scan.vulnerabilities_count }} found</span>
                                            {% else %}
                                                <span class="badge bg-success">0 found</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if scan.status == 'completed' %}
                                            <span class="badge bg-{{ 'danger' if scan.security_score < 50 else 'warning' if scan.security_score < 80 else 'success' }}">
                                                {{ scan.security_score }}/100
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted scan-timestamp" data-timestamp="{{ scan.created_at.isoformat() }}">
                                            {{ scan.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            {% if scan.status == 'completed' %}
                                            <a href="{{ url_for('results', scan_id=scan.id) }}" class="btn btn-primary" title="View Results">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% endif %}
                                            <button onclick="deleteScan('{{ scan.id }}')" class="btn btn-outline-danger" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No scans yet. Start your first scan above!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
    {{ super() }}
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
    // Helper to darken color
    function shadeColor(color, percent) {
        // color in hex, percent negative to darken
        let R = parseInt(color.substring(1,3),16);
        let G = parseInt(color.substring(3,5),16);
        let B = parseInt(color.substring(5,7),16);
        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);
        R = (R<255)?R:255;  G = (G<255)?G:255;  B = (B<255)?B:255;
        let RR = ((R.toString(16).length==1)?"0":"") + R.toString(16);
        let GG = ((G.toString(16).length==1)?"0":"") + G.toString(16);
        let BB = ((B.toString(16).length==1)?"0":"") + B.toString(16);
        return "#"+RR+GG+BB;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Vulnerability filter dropdown logic
        const vulnFilterDropdown = document.querySelector('#vulnFilterDropdown');
        if (vulnFilterDropdown) {
            const dropdownMenu = vulnFilterDropdown.nextElementSibling;
            dropdownMenu.addEventListener('click', function(e) {
                if (e.target.classList.contains('vuln-filter-checkbox') || e.target.closest('label')) {
                    e.stopPropagation();
                }
            });
        }

        // Chart rendering logic with debug
        fetch('/dashboard-charts-data')
            .then(res => res.json())
            .then(data => {
                // Vulnerabilities by Type (Horizontal Bar Chart)
                const typeLabels = Object.keys(data.by_type);
                const typeCounts = Object.values(data.by_type);
                const typeColors = [
                    '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0', '#6c757d'
                ];
                const typeCanvas = document.getElementById('vulnTypeChart');
                if (!typeCanvas) { console.error('vulnTypeChart canvas not found'); return; }
                const ctxType = typeCanvas.getContext('2d');
                if (typeLabels.length > 0) {
                    new Chart(ctxType, {
                        type: 'bar',
                        data: {
                            labels: typeLabels,
                            datasets: [{
                                label: 'Count',
                                data: typeCounts,
                                backgroundColor: typeColors,
                                borderWidth: 2,
                                borderRadius: 4,
                                hoverBackgroundColor: typeColors.map(c => shadeColor(c, -20)), // Slightly darker on hover
                                hoverBorderWidth: 6
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: true,
                            animation: { duration: 300 },
                            plugins: {
                                legend: { display: false },
                                title: { display: false },
                                tooltip: { enabled: true }
                            },
                            hover: { mode: 'point', intersect: true },
                            interaction: { mode: 'point', intersect: true },
                            elements: {
                                bar: {
                                    borderWidth: 2,
                                    borderRadius: 4
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 }
                                }
                            }
                        }
                    });
                } else {
                    console.warn('No data for Vulnerabilities by Type');
                }

                // Vulnerabilities by Severity (Doughnut)
                const severityLabels = Object.keys(data.by_severity);
                const severityCounts = Object.values(data.by_severity);
                
                // Map severity levels to distinct colors
                const severityColorMap = {
                    'Critical': '#8b0000',  // Dark red
                    'High': '#dc3545',      // Red
                    'Medium': '#ffc107',    // Yellow/Orange
                    'Low': '#0dcaf0',       // Cyan
                    'Info': '#6c757d',      // Gray
                    'Other': '#adb5bd'      // Light gray
                };
                
                // Get colors in the same order as labels
                const severityColors = severityLabels.map(label => severityColorMap[label] || '#adb5bd');
                
                const severityCanvas = document.getElementById('vulnSeverityChart');
                if (!severityCanvas) { console.error('vulnSeverityChart canvas not found'); return; }
                const ctxSeverity = severityCanvas.getContext('2d');
                if (severityLabels.length > 0) {
                    new Chart(ctxSeverity, {
                        type: 'doughnut',
                        data: {
                            labels: severityLabels,
                            datasets: [{
                                data: severityCounts,
                                backgroundColor: severityColors,
                                hoverBackgroundColor: severityColors.map(c => shadeColor(c, -20)),
                                hoverBorderWidth: 0,
                                hoverOffset: 16
                            }]
                        },
                        options: {
                            animation: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true
                                    }
                                },
                                title: { display: false },
                                tooltip: { enabled: true }
                            },
                            onHover: (event, activeElements) => {
                                event.native.target.style.cursor = 'pointer';
                            },
                            elements: {
                                arc: {
                                    borderWidth: 0,
                                    hoverBorderWidth: 0,
                                    hoverOffset: 16
                                }
                            }
                        }
                    });
                } else {
                    console.warn('No data for Vulnerabilities by Severity');
                }
            })
            .catch(err => {
                console.error('Error fetching chart data:', err);
            });
    });
    </script>
    <script>
    // Restore filterSeverity for stats card
    function filterSeverity(level) {
        // Button highlight
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        if (level === 'all') {
            document.getElementById('filterAll').classList.add('active');
        } else if (level === 'critical') {
            document.getElementById('filterCritical').classList.add('active');
        } else if (level === 'high') {
            document.getElementById('filterHigh').classList.add('active');
        } else if (level === 'medium') {
            document.getElementById('filterMedium').classList.add('active');
        } else if (level === 'low') {
            document.getElementById('filterLow').classList.add('active');
        } else if (level === 'info') {
            document.getElementById('filterInfo').classList.add('active');
        }
        // Get counts from the chart data (already fetched by Chart.js)
        const chartData = window.dashboardSeverityData;
        let count = 0;
        let label = '';
        if (!chartData) {
            // fallback: just show total
            count = document.getElementById('severityCount').dataset.total || document.getElementById('severityCount').textContent;
            label = 'Total vulnerabilities';
        } else if (level === 'all') {
            count = Object.values(chartData).reduce((a, b) => a + b, 0);
            label = 'Total vulnerabilities';
        } else {
            const key = level.charAt(0).toUpperCase() + level.slice(1);
            count = chartData[key] || 0;
            label = key + ' severity';
        }
        document.getElementById('severityCount').textContent = count;
        document.getElementById('severityLabel').textContent = label;
    }
    // Save chart data for filterSeverity
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/dashboard-charts-data')
            .then(res => res.json())
            .then(data => {
                window.dashboardSeverityData = data.by_severity;
                // Set initial count and label
                filterSeverity('all');
            });
    });
    </script>
{% endblock %}

